# 一. 系统设计基础

## 1.1 通用方法

高并发系统设计归纳起来共有三种方法。

- Scale-out（横向扩展）：分而治之是一种常见的高并发系统设计方法，采用分布式部署的方式把流量分流开，让每个服务器都承担一部分并发和流量。（一般是Scale-up（纵向扩展）单机性能挖掘到极限的情况）
- 缓存：使用缓存来提高系统的性能，就好比用“拓宽河道”的方式抵抗高并发大流量的冲击。
- 异步：在某些场景下，未处理完成之前我们可以让请求先返回，在数据准备好之后再通知请求方，这样可以在单位时间内处理更多的请求。

高并发系统的演进应该是循序渐进，以解决系统中存在的问题为目的和驱动力的。

## 1.2 架构分层

软件架构分层在软件工程中是一种常见的设计方式，它是将整体系统拆分成 N 个层次，每个层次有独立的职责，多个层次协同提供完整的功能。

分层的**好处**如下：

- 分层的设计可以简化系统设计，让不同的人专注做某一层次的事情。
- 分层之后可以做到很高的复用。
- 分层架构可以更容易做横向扩展。

分层的**不足**是可能会增加代码的复杂度。

## 1.3 系统设计目标

**高并发系统设计的三大目标：高性能、高可用、可扩展**

高并发，是指运用设计手段让系统能够处理更多的用户并发请求，也就是承担更大的流量。

### 1.3.1 高性能

**性能优化原则：**

首先，性能优化一定不能盲目，一定是问题导向的。脱离了问题，盲目地提早优化会增加系统的复杂度，浪费开发人员的时间，也因为某些优化可能会对业务上有些折中的考虑，所以也会损伤业务。

其次，性能优化也遵循“八二原则”，即你可以用 20% 的精力解决 80% 的性能问题。

再次，性能优化也要有数据支撑。在优化过程中，你要时刻了解你的优化让响应时间减少了多少，提升了多少的吞吐量。

最后，性能优化的过程是持续的。高并发的系统通常是业务逻辑相对复杂的系统，那么在这类系统中出现的性能问题通常也会有多方面的原因。

**性能的度量指标**（吞吐量和响应时间）：

度量性能的指标是系统接口的响应时间，具体的指标如下：

平均值：顾名思义，平均值是把这段时间所有请求的响应时间数据相加，再除以总请求数。平均值可以在一定程度上反应这段时间的性能，但它敏感度比较差，如果这段时间有少量慢请求时，在平均值上并不能如实地反应。

最大值：这段时间内所有请求响应时间最长的值，但它的问题又在于过于敏感了。

分位值：分位值排除了偶发极慢请求对于数据的影响，能够很好地反应这段时间的性能情况，分位值越大，对于慢请求的影响就越敏感。

**性能优化：**

1. 提高系统的处理核心数。

    但并非无限增加核心数就可以增加吞吐量，随着进程数增加，并行的任务对于资源的争夺也增加，在某
    个临界点，进程增加导致系统的性能下降，这就是性能测试中的拐点模型，所以在评估系统性能时，需要做压力测试，找到拐点。

2. 减少单次任务的响应时间。

   cpu密集型：优化算法
   io密集型：1.采用工具，linux的工具集
                   2.通过监控，对任务的每一个步骤做分时统计，从而找到任务中哪一步消耗了更多的时间

### 1.3.2 高可用

高可用性（High Availability，HA），指的是系统具备较高的无故障运行的能力。

**可用性的度量：**

MTBF（Mean Time Between Failure）是平均故障间隔的意思，代表两次故障的间隔时间，也就是系统正常运转的平均时间。这个时间越长，系统稳定性越高。

MTTR（Mean Time To Repair）表示故障的平均恢复时间，也可以理解为平均故障时间。这个值越小，故障对于用户的影响越小。

可用性与 MTBF 和 MTTR 的值息息相关，我们可以用下面的公式表示它们之间的关系：

$Availability = MTBF / (MTBF + MTTR)$

这个公式计算出的结果是一个比例，而这个比例代表着系统的可用性。

<img src="https://static001.geekbang.org/resource/image/73/75/73a87a9bc14a27c9ec9dfda1b72e1e75.jpg" alt="img" style="zoom:50%;" />

一般来说，我们的核心业务系统的可用性，需要达到四个九，非核心系统的可用性最多容忍到三个九。

**高可用思路**

1. 开发设计层面
   冗余---主备，负载均衡，failover（故障转移）
   取舍----降级，限流，熔断，超时控制

2. 运维层面
   灰度发布，故障演练，监控报警

### 1.3.3 拓展性

数据库、缓存、依赖的第三方、负载均衡、交换机带宽等等都是系统扩展时需要考虑的因素。

拆分是提升系统扩展性最重要的一个思路，它会把庞杂的系统拆分成独立的，有单一职责的模块。

存储层和业务层都可以进行拆分。